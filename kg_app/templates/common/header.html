{% load static %}

<style>
  #currentDateTime {
    font-size: 13px;
    font-weight: 600;
    color: #1e40af;
    white-space: nowrap;
  }
</style>

<style>
  .header-info h4 {
    margin: 0;
    font-weight: 600;
    color: #0f172a;
  }

  .header-info span {
    font-size: 13px;
    color: #2563eb;
  }

  .tooltip-wrapper {
    position: relative;
    display: inline-block;
  }

  .tooltip-text {
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: #000;
    color: #fff;
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .tooltip-wrapper:hover .tooltip-text {
    opacity: 1;
  }

</style>

<header class="page-header row">
  <div class="logo-wrapper d-flex align-items-right col-auto"><a href="{% url 'kg_app:dashboard' %}"><img
        class="light-logo img-fluid" src="{% static 'assets/img/logo-3.png' %}" alt="logo"><img
        class="dark-logo img-fluid" src="{% static 'assets/img/logo-3.png' %}" alt="logo"></a><a
      class="close-btn toggle-sidebar" href="javascript:void(0)">
      <svg class="svg-color">
        <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Category"></use>
      </svg></a></div>
  <div class="page-main-header col">
    <div class="header-left">
      <div class="header-info">
        <h4 id="greetingText"></h4>
      </div>
      <form class="form-inline search-full col" action="#" method="get">
        <div class="form-group w-100">
          <div class="Typeahead Typeahead--twitterUsers">
            <div class="u-posRelative">
              <input class="demo-input Typeahead-input form-control-plaintext w-100" type="text"
                placeholder="Search Admiro .." name="q" title="" autofocus="autofocus">
              <div class="spinner-border Typeahead-spinner" role="status"><span class="sr-only">Loading...</span>
              </div><i class="close-search" data-feather="x"></i>
            </div>
            <div class="Typeahead-menu"></div>
          </div>
        </div>
      </form>
    </div>
    <div class="nav-right">
      <ul class="header-right">
        <!-- <li class="search d-lg-none d-flex"> <a href="javascript:void(0)">
            <svg>
              <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Search"></use>
            </svg></a>
        </li> -->

        
        <span id="currentDateTime"></span>
        <li> <a class="dark-mode" href="javascript:void(0)">
            <svg>
              <use href="{% static 'assets/svg/iconly-sprite.svg' %}#moondark"></use>
            </svg></a>
        </li>
        
        <li>
          <a href="{% static 'assets/apk/app-release_(1.0.1).apk' %}" download title="Download APK">
            <svg>
              <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Arrow--Download" title="Download APK"></use>
            </svg>
            <span class="tooltip-text">Download APK</span>
          </a>
        </li>

            
        <li class="custom-dropdown">
          <a href="javascript:void(0)">
            <svg>
              <use href="{% static 'assets/svg/iconly-sprite.svg' %}#notification"></use>
            </svg>
          </a>
          <span class="badge rounded-pill badge-primary">{{ notification_count|default:0 }}</span>
          <div class="custom-menu notification-dropdown py-0 overflow-hidden">
            <h3 class="title bg-primary-light dropdown-title">Notification
              <a href="{% url 'kg_app:feddback_history' %}" class="font-primary">
                View all
              </a>
            </h3>
            <ul class="activity-timeline">
              {% for update in recent_updates %}
              <li class="d-flex align-items-start">
                <div class="activity-line"></div>
                <div class="activity-dot-primary"></div>
                <div class="flex-grow-1">
                  <h6 class="f-w-600 font-primary">
                    {{ update.updated_at|date:"d-m-Y" }}
                    <span>{{ update.updated_at|timesince }} ago</span>
                    <span class="circle-dot-primary float-end">
                      <svg class="circle-color">
                        <use href="{% static 'assets/svg/iconly-sprite.svg' %}#circle"></use>
                      </svg>
                    </span>
                  </h6>
                  <h5>{{ update.updated_by|default:"Admin"|capfirst }} - Agreement: {{ update.agreement_id }}</h5>
                  <p class="mb-0">
                    Projection: {{ update.projection|default:"N/A" }} |
                    Status: {{ update.location_status|default:"N/A" }}
                  </p>
                </div>
              </li>
              {% empty %}
              <li class="d-flex align-items-start">
                <div class="flex-grow-1 text-center py-3">
                  <p class="mb-0">No recent updates available</p>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </li>

        <li class="profile-nav custom-dropdown">
          <div class="user-wrap">
            <div class="user-img"><img src="{% static 'assets/images/profile.png' %}" alt="user"></div>
            <div class="user-content">
              <h6>{{ request.session.admin_username }}</h6>
              <p class="mb-0">Admin<i class="fa-solid fa-chevron-down"></i></p>
            </div>
          </div>
          <div class="custom-menu overflow-hidden">
            <ul class="profile-body">
              <li class="d-flex">
                <svg class="svg-color">
                  <use href="{% static 'assets/svg/iconly-sprite.svg' %}#Login"></use>
                </svg><a class="ms-2" onclick="refreshAndLogout()">Log Out</a>
              </li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
  </div>
</header>

<script>
  function refreshAndLogout() {
    location.reload();
    window.location.href = "{% url 'kg_app:admin_logout' %}";
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    // Get username from Django session
    let userName = "{{ request.session.admin_username|default:'User'|escapejs }}";

    // Trim + Capitalize first letter
    function capitalizeFirstLetter(name) {
      name = name.trim();
      if (name.length === 0) return "User";
      return name[0].toUpperCase() + name.slice(1);
    }

    userName = capitalizeFirstLetter(userName);

    function updateGreetingAndTime() {
      const now = new Date();

      // ðŸ‡®ðŸ‡³ Force Indian Time
      const indianTime = new Date(
        now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
      );

      const hour = indianTime.getHours();
      let greeting = "Hello";

      if (hour >= 5 && hour < 12) greeting = "Good Morning";
      else if (hour >= 12 && hour < 17) greeting = "Good Afternoon";
      else if (hour >= 17 && hour < 21) greeting = "Good Evening";
      else greeting = "Good Night";

      document.getElementById("greetingText").innerText =
        greeting + ", " + userName;

      document.getElementById("currentDateTime").innerText =
        indianTime.toLocaleString("en-IN", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: true
        });
    }

    // Run immediately
    updateGreetingAndTime();

    // Update every second
    setInterval(updateGreetingAndTime, 1000);

  });
</script>